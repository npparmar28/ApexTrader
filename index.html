<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Live Intraday Trading Simulator</title>
  
  <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js and Annotation Plugin for visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

  <!-- Google Fonts: Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* Custom styles and theme configuration */
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial;
      -webkit-tap-highlight-color: transparent;
    }

    /* Custom scrollbar for a cleaner look */
    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
      background: #1f2937;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #4b5563;
      border-radius: 2px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #6b7280;
    }
    
    /* Custom focus ring for better accessibility */
    .focus-ring {
      transition: box-shadow 0.2s ease-in-out;
    }
    .focus-ring:focus {
      outline: none;
      box-shadow: 0 0 0 2px #3b82f6;
    }

    /* Animation for modals */
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .modal-fade-in {
      animation: fadeIn 0.2s ease-out forwards;
    }
    
    /* Auto-save indicator */
    .save-indicator {
      transition: all 0.3s ease;
    }
    .save-indicator.saving {
      opacity: 0.7;
    }
    .save-indicator.saved {
      opacity: 1;
    }
    
    /* Notification styling */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      padding: 16px;
      border-radius: 8px;
      background-color: #1f2937;
      border-left: 4px solid #3b82f6;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.success {
      border-left-color: #10b981;
    }
    
    .notification.warning {
      border-left-color: #f59e0b;
    }
    
    .notification.error {
      border-left-color: #ef4444;
    }
    
    /* Price ticker animation */
    @keyframes flashGreen {
      0% { background-color: transparent; }
      50% { background-color: rgba(34, 197, 94, 0.3); }
      100% { background-color: transparent; }
    }
    
    @keyframes flashRed {
      0% { background-color: transparent; }
      50% { background-color: rgba(239, 68, 68, 0.3); }
      100% { background-color: transparent; }
    }
    
    .price-up {
      animation: flashGreen 0.5s ease;
    }
    
    .price-down {
      animation: flashRed 0.5s ease;
    }
    
    /* Live price indicator */
    .live-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #10b981;
      margin-right: 6px;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.4; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

  <!-- Loading Spinner -->
  <div id="loading" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50 transition-opacity duration-300">
    <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
  </div>

  <!-- Main Application Wrapper -->
  <main id="mainContent" class="max-w-6xl mx-auto p-2 sm:p-4 opacity-0 transition-opacity duration-300">
    
    <!-- Header -->
    <header class="flex items-center justify-between mb-4 px-2">
      <h1 class="text-xl sm:text-2xl font-bold text-gray-100 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-blue-400"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"></path></svg>
        Live Intraday Trading Simulator
      </h1>
      <div class="flex items-center">
        <span id="saveStatus" class="save-indicator text-xs font-medium bg-gray-700 text-green-400 px-2 py-1 rounded-full mr-2">Auto-save: ON</span>
        <div class="flex items-center text-xs font-medium bg-gray-700 text-blue-300 px-2 py-1 rounded-full">
          <span class="live-indicator"></span>
          <span>Live Prices</span>
        </div>
      </div>
    </header>

    <!-- Live Price Ticker -->
    <div class="mb-4 px-2 bg-gray-800 rounded-lg p-3 flex items-center justify-between">
      <div class="flex items-center">
        <span class="text-sm text-gray-400 mr-2">NIFTY 50:</span>
        <span id="niftyPrice" class="text-xl font-bold text-white">17,850.25</span>
        <span id="niftyChange" class="ml-2 text-sm font-medium text-green-400">+42.75 (+0.24%)</span>
      </div>
      <div class="flex items-center">
        <span class="text-sm text-gray-400 mr-2">BANK NIFTY:</span>
        <span id="bankNiftyPrice" class="text-xl font-bold text-white">41,382.60</span>
        <span id="bankNiftyChange" class="ml-2 text-sm font-medium text-red-400">-128.40 (-0.31%)</span>
      </div>
    </div>

    <!-- Tabs Section -->
    <div class="mb-4 px-2">
      <div id="tabsContainer" class="flex items-center space-x-2 overflow-x-auto custom-scrollbar pb-2">
        <!-- Tabs will be dynamically inserted here -->
      </div>
    </div>

    <!-- Main Grid Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

      <!-- Left Column: Inputs and Controls -->
      <div class="flex flex-col gap-4 lg:col-span-2">
        
        <!-- Setup Card -->
        <section class="bg-gray-800 border border-gray-700 rounded-xl shadow-lg p-4">
          <div class="flex items-center justify-between mb-4">
             <h2 class="text-lg font-semibold text-gray-100">Trade Setup</h2>
             <div class="flex space-x-2">
               <button id="tradeType" class="px-3 py-2 text-sm font-bold rounded-lg transition-all duration-200 bg-blue-600 text-white focus-ring">
                 INTRADAY
               </button>
               <button id="tradeDirection" class="px-4 py-2 text-sm font-bold rounded-lg transition-all duration-200 w-28 bg-green-600 hover:bg-green-700 text-white focus-ring">
                 Long ▲
               </button>
             </div>
          </div>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label for="scriptName" class="text-sm font-medium text-gray-400 mb-1 block">Script Name</label>
              <select id="scriptName" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus-ring">
                <option value="RELIANCE">RELIANCE</option>
                <option value="TATASTEEL">TATASTEEL</option>
                <option value="HDFCBANK">HDFCBANK</option>
                <option value="INFY">INFY</option>
                <option value="ICICIBANK">ICICIBANK</option>
                <option value="SBIN">SBIN</option>
              </select>
            </div>
            <div>
              <label for="currentPrice" class="text-sm font-medium text-gray-400 mb-1 block">Current Price</label>
              <div class="relative">
                <input type="number" id="currentPrice" inputmode="decimal" placeholder="Live price" step="0.05" class="w-full bg-gray-900 border border-gray-600 rounded-lg pl-8 pr-3 py-2 text-gray-200 focus-ring">
                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">₹</span>
              </div>
            </div>
            <div>
              <label for="risk" class="text-sm font-medium text-gray-400 mb-1 block">Max Risk</label>
              <div class="relative">
                <input type="number" id="risk" inputmode="decimal" value="1000" step="0.01" class="w-full bg-gray-900 border border-gray-600 rounded-lg pl-8 pr-3 py-2 text-gray-200 focus-ring">
                <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-400">₹</span>
              </div>
            </div>
            <div>
              <label for="levelType" class="text-sm font-medium text-gray-400 mb-1 block">Level Type</label>
              <select id="levelType" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus-ring">
                <option value="3">3 Levels</option>
                <option value="5" selected>5 Levels</option>
                <option value="7">7 Levels</option>
                <option value="10">10 Levels</option>
              </select>
            </div>
          </div>
        </section>

        <!-- Position Sizing Card -->
        <section class="bg-gray-800 border border-gray-700 rounded-xl shadow-lg p-4">
          <h2 class="text-lg font-semibold text-gray-100 mb-4">Position Sizing</h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
              <div>
                <label for="entryPrice" class="text-sm font-medium text-gray-400 mb-1 block">Initial Entry Price</label>
                <input type="number" id="entryPrice" placeholder="Entry" step="0.05" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus-ring">
              </div>
              <div>
                <label for="stoplossPrice" class="text-sm font-medium text-gray-400 mb-1 block">Stoploss Price</label>
                <input type="number" id="stoplossPrice" placeholder="Stoploss" step="0.05" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus-ring">
              </div>
          </div>
          <div class="bg-gray-900 rounded-lg p-3 space-y-2 text-sm">
              <div class="flex justify-between items-center">
                  <span class="text-gray-400">Risk per Share:</span>
                  <span id="riskPerShare" class="font-semibold text-gray-200">—</span>
              </div>
              <div class="flex justify-between items-center">
                  <span class="text-gray-400">Calculated Position Size:</span>
                  <span id="positionSize" class="font-semibold text-gray-200">—</span>
              </div>
          </div>
          <button id="distributeBtn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 focus-ring flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Auto-Distribute Entries
          </button>
           <div class="flex space-x-2 mt-2">
            <button id="addSample" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-200 font-semibold py-2 px-3 text-xs rounded-lg transition-colors duration-200 focus-ring">Sample Data</button>
            <button id="reset" class="w-full bg-red-800 hover:bg-red-700 text-gray-200 font-semibold py-2 px-3 text-xs rounded-lg transition-colors duration-200 focus-ring">Reset Tab</button>
           </div>
        </section>
        
        <!-- Entries Card -->
        <section class="bg-gray-800 border border-gray-700 rounded-xl shadow-lg p-4">
            <h2 class="text-lg font-semibold text-gray-100 mb-2">Pyramid Entries</h2>
            <p class="text-xs text-gray-400 mb-4">Enter the price for each distributed entry level. Values are calculated automatically.</p>
            <div id="entriesContainer" class="space-y-3 max-h-60 overflow-y-auto custom-scrollbar pr-2">
                <!-- Entry cards will be dynamically inserted here -->
            </div>
        </section>
      </div>

      <!-- Right Column: Summary and Table -->
      <div class="flex flex-col gap-4">
        
        <!-- Summary Card -->
        <section class="bg-gray-800 border border-gray-700 rounded-xl shadow-lg p-4">
          <h2 class="text-lg font-semibold text-gray-100 mb-4">Trade Summary</h2>
          <div class="grid grid-cols-2 gap-4 text-center">
            <div>
              <div class="text-sm text-gray-400">Total Position</div>
              <div id="summaryPosition" class="text-xl font-bold text-gray-100 mt-1">—</div>
            </div>
            <div>
              <div class="text-sm text-gray-400">Average Price</div>
              <div id="summaryAvgPrice" class="text-xl font-bold text-gray-100 mt-1">—</div>
            </div>
            <div>
              <div class="text-sm text-gray-400">Total Value</div>
              <div id="summaryTotalValue" class="text-xl font-bold text-gray-100 mt-1">—</div>
            </div>
             <div>
              <div class="text-sm text-gray-400">Combined Stoploss</div>
              <div id="combinedSL" class="text-xl font-bold mt-1">—</div>
            </div>
          </div>
           <div class="mt-4 pt-4 border-t border-gray-700 text-center">
              <div class="text-sm text-gray-400">Live P&L</div>
              <div id="summaryPnl" class="text-2xl font-bold mt-1">—</div>
           </div>
        </section>

        <!-- Results Table Card -->
        <section class="bg-gray-800 border border-gray-700 rounded-xl shadow-lg p-4 flex-grow flex flex-col">
          <h2 class="text-lg font-semibold text-gray-100 mb-4">Execution Plan</h2>
          <div class="flex-grow overflow-auto custom-scrollbar">
            <table class="w-full text-sm text-left">
              <thead class="text-xs text-gray-400 uppercase bg-gray-900 sticky top-0">
                <tr>
                  <th class="p-3">Level</th>
                  <th class="p-3 text-right">Qty</th>
                  <th class="p-3 text-right">Price</th>
                  <th class="p-3 text-right">Value</th>
                  <th class="p-3 text-right">Status</th>
                  <th class="p-3 text-right">P&L @Now</th>
                </tr>
              </thead>
              <tbody id="tbody" class="divide-y divide-gray-700">
                <!-- Table rows will be dynamically inserted here -->
              </tbody>
            </table>
          </div>
        </section>

        <!-- Visualization Card -->
        <section class="bg-gray-800 border border-gray-700 rounded-xl shadow-lg p-4">
            <h2 class="text-lg font-semibold text-gray-100 mb-4">Price Visualization</h2>
            <div class="h-64">
                <canvas id="priceChart"></canvas>
            </div>
        </section>
      </div>
    </div>
  </main>
  
  <!-- Custom Modal -->
  <div id="customModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden p-4">
    <div class="bg-gray-800 rounded-xl shadow-2xl p-6 w-full max-w-sm modal-fade-in">
      <h3 id="modalTitle" class="text-lg font-bold text-white mb-2">Modal Title</h3>
      <p id="modalMessage" class="text-gray-300 mb-6">Modal message goes here.</p>
      <div id="modalInputContainer" class="mb-6 hidden">
        <input type="text" id="modalInput" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-gray-200 focus-ring">
      </div>
      <div class="flex justify-end space-x-3">
        <button id="modalCancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white font-semibold rounded-lg transition-colors duration-200 focus-ring">Cancel</button>
        <button id="modalConfirm" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors duration-200 focus-ring">Confirm</button>
      </div>
    </div>
  </div>
  
  <!-- Notification Container -->
  <div id="notificationContainer"></div>

<script>
// --- APPLICATION LOGIC ---
document.addEventListener('DOMContentLoaded', () => {

  // --- CONFIGURATION ---
  const STORAGE_KEY_PREFIX = 'intradayTradingSimulator';
  const DEFAULT_STATE = {
    entries: [],
    isLong: true,
    isIntraday: true,
    currency: '₹',
    risk: 1000,
    currentPrice: '',
    scriptName: 'RELIANCE',
    levelType: '5',
    entryPrice: '',
    stoplossPrice: '',
    totalShares: 0,
  };
  
  // Distribution ratios for different level types
  const DISTRIBUTION_RATIOS = {
    '3': [6, 3, 1],
    '5': [4, 2, 2, 1, 1],
    '7': [3, 2, 2, 1, 1, 0.5, 0.5],
    '10': [2, 2, 1.5, 1.5, 1, 1, 0.5, 0.5, 0.25, 0.25]
  };
  
  // Base prices for popular stocks
  const STOCK_PRICES = {
    'RELIANCE': 2580.50,
    'TATASTEEL': 112.75,
    'HDFCBANK': 1642.30,
    'INFY': 1855.60,
    'ICICIBANK': 934.85,
    'SBIN': 595.40
  };

  // --- STATE MANAGEMENT ---
  let state = { ...DEFAULT_STATE };
  let tabs = {};
  let currentTabId = 'tab_1';
  let chartInstance = null;
  let autoSaveTimeout = null;
  let priceUpdateInterval = null;
  let niftyPrice = 17850.25;
  let bankNiftyPrice = 41382.60;

  // --- ELEMENT CACHING ---
  const els = {
    // Main layout
    loading: document.getElementById('loading'),
    mainContent: document.getElementById('mainContent'),
    
    // Tabs
    tabsContainer: document.getElementById('tabsContainer'),
    saveStatus: document.getElementById('saveStatus'),

    // Setup Card
    tradeType: document.getElementById('tradeType'),
    tradeDirection: document.getElementById('tradeDirection'),
    scriptName: document.getElementById('scriptName'),
    currentPrice: document.getElementById('currentPrice'),
    risk: document.getElementById('risk'),
    levelType: document.getElementById('levelType'),

    // Sizing Card
    entryPrice: document.getElementById('entryPrice'),
    stoplossPrice: document.getElementById('stoplossPrice'),
    riskPerShare: document.getElementById('riskPerShare'),
    positionSize: document.getElementById('positionSize'),
    distributeBtn: document.getElementById('distributeBtn'),
    addSample: document.getElementById('addSample'),
    reset: document.getElementById('reset'),

    // Entries
    entriesContainer: document.getElementById('entriesContainer'),

    // Summary
    summaryPosition: document.getElementById('summaryPosition'),
    summaryAvgPrice: document.getElementById('summaryAvgPrice'),
    summaryTotalValue: document.getElementById('summaryTotalValue'),
    combinedSL: document.getElementById('combinedSL'),
    summaryPnl: document.getElementById('summaryPnl'),

    // Table & Chart
    tbody: document.getElementById('tbody'),
    priceChart: document.getElementById('priceChart'),
    
    // Index prices
    niftyPrice: document.getElementById('niftyPrice'),
    niftyChange: document.getElementById('niftyChange'),
    bankNiftyPrice: document.getElementById('bankNiftyPrice'),
    bankNiftyChange: document.getElementById('bankNiftyChange'),
    
    // Modal
    customModal: document.getElementById('customModal'),
    modalTitle: document.getElementById('modalTitle'),
    modalMessage: document.getElementById('modalMessage'),
    modalInputContainer: document.getElementById('modalInputContainer'),
    modalInput: document.getElementById('modalInput'),
    modalCancel: document.getElementById('modalCancel'),
    modalConfirm: document.getElementById('modalConfirm'),
    
    // Notifications
    notificationContainer: document.getElementById('notificationContainer')
  };

  // --- UTILITY FUNCTIONS ---
  const safeGet = (key) => {
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : null;
    } catch (e) { console.error(`Failed to get item '${key}' from localStorage`, e); return null; }
  };

  const safeSet = (key, value) => {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch (e) { console.error(`Failed to set item '${key}' in localStorage`, e); }
  };

  const fmt = (n) => (isNaN(n) || !isFinite(n)) ? '—' : n.toLocaleString(undefined, { maximumFractionDigits: 0 });
  const fmt2 = (n) => (isNaN(n) || !isFinite(n)) ? '—' : n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const cur = (n) => (isNaN(n) || !isFinite(n)) ? '—' : `${state.currency} ${n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  
  const debounce = (func, delay) => {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), delay);
    };
  };
  
  // Show notification
  function showNotification(message, type = 'info', duration = 5000) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <div class="flex items-start">
        <div class="flex-1">
          <p class="text-sm font-medium text-gray-100">${message}</p>
        </div>
        <button class="ml-4 text-gray-400 hover:text-gray-200" onclick="this.parentElement.parentElement.remove()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    `;
    
    els.notificationContainer.appendChild(notification);
    
    // Animate in
    setTimeout(() => notification.classList.add('show'), 10);
    
    // Auto remove after duration
    if (duration > 0) {
      setTimeout(() => {
        if (notification.parentNode) {
          notification.classList.remove('show');
          setTimeout(() => notification.parentNode.removeChild(notification), 300);
        }
      }, duration);
    }
    
    return notification;
  }

  // --- AUTO-SAVE FUNCTIONALITY ---
  function triggerAutoSave() {
    // Clear any existing timeout
    if (autoSaveTimeout) {
      clearTimeout(autoSaveTimeout);
    }
    
    // Show saving status
    els.saveStatus.textContent = 'Auto-save: Saving...';
    els.saveStatus.classList.remove('saved');
    els.saveStatus.classList.add('saving');
    
    // Set a new timeout to save after 1 second of inactivity
    autoSaveTimeout = setTimeout(() => {
      saveCurrentTabState();
      
      // Show saved status briefly
      els.saveStatus.textContent = 'Auto-save: Saved';
      els.saveStatus.classList.remove('saving');
      els.saveStatus.classList.add('saved');
      
      // Revert to normal status after 2 seconds
      setTimeout(() => {
        els.saveStatus.textContent = 'Auto-save: ON';
        els.saveStatus.classList.remove('saved');
      }, 2000);
    }, 1000);
  }

  // --- MODAL LOGIC ---
  const Modal = {
    confirmCallback: null,
    cancelCallback: null,

    show({ title, message, confirmText = 'Confirm', cancelText = 'Cancel', showInput = false, inputValue = '' }) {
      return new Promise((resolve) => {
        this.confirmCallback = () => resolve(showInput ? els.modalInput.value : true);
        this.cancelCallback = () => resolve(false);

        els.modalTitle.textContent = title;
        els.modalMessage.textContent = message;
        els.modalConfirm.textContent = confirmText;
        els.modalCancel.textContent = cancelText;
        
        if (showInput) {
            els.modalInputContainer.classList.remove('hidden');
            els.modalInput.value = inputValue;
            setTimeout(() => els.modalInput.focus(), 50);
        } else {
            els.modalInputContainer.classList.add('hidden');
        }

        els.customModal.classList.remove('hidden');
      });
    },

    hide() {
      els.customModal.classList.add('hidden');
      if (this.cancelCallback) {
        this.cancelCallback();
        this.cancelCallback = null;
      }
    },

    handleConfirm() {
      els.customModal.classList.add('hidden');
      if (this.confirmCallback) {
        this.confirmCallback();
        this.confirmCallback = null;
      }
    },
    
    init() {
        els.modalConfirm.addEventListener('click', () => this.handleConfirm());
        els.modalCancel.addEventListener('click', () => this.hide());
    }
  };
  Modal.init();

  // --- LIVE PRICE SIMULATION ---
  function updateIndexPrices() {
    // Generate random price changes for indices
    const niftyChange = (Math.random() - 0.5) * 40;
    const bankNiftyChange = (Math.random() - 0.5) * 100;
    
    niftyPrice += niftyChange;
    bankNiftyPrice += bankNiftyChange;
    
    // Update DOM with new prices
    els.niftyPrice.textContent = niftyPrice.toFixed(2);
    els.bankNiftyPrice.textContent = bankNiftyPrice.toFixed(2);
    
    // Calculate percentage changes
    const niftyPercent = (niftyChange / (niftyPrice - niftyChange)) * 100;
    const bankNiftyPercent = (bankNiftyChange / (bankNiftyPrice - bankNiftyChange)) * 100;
    
    // Update change indicators
    els.niftyChange.textContent = `${niftyChange >= 0 ? '+' : ''}${niftyChange.toFixed(2)} (${niftyPercent >= 0 ? '+' : ''}${niftyPercent.toFixed(2)}%)`;
    els.niftyChange.className = `ml-2 text-sm font-medium ${niftyChange >= 0 ? 'text-green-400' : 'text-red-400'}`;
    
    els.bankNiftyChange.textContent = `${bankNiftyChange >= 0 ? '+' : ''}${bankNiftyChange.toFixed(2)} (${bankNiftyPercent >= 0 ? '+' : ''}${bankNiftyPercent.toFixed(2)}%)`;
    els.bankNiftyChange.className = `ml-2 text-sm font-medium ${bankNiftyChange >= 0 ? 'text-green-400' : 'text-red-400'}`;
    
    // Flash animation for price changes
    els.niftyPrice.classList.remove('price-up', 'price-down');
    els.bankNiftyPrice.classList.remove('price-up', 'price-down');
    
    setTimeout(() => {
      els.niftyPrice.classList.add(niftyChange >= 0 ? 'price-up' : 'price-down');
      els.bankNiftyPrice.classList.add(bankNiftyChange >= 0 ? 'price-up' : 'price-down');
    }, 10);
  }
  
  function updateStockPrice() {
    if (!els.currentPrice.value) return;
    
    const currentPrice = parseFloat(els.currentPrice.value);
    const volatility = currentPrice * 0.002; // 0.2% volatility
    const priceChange = (Math.random() - 0.5) * volatility * 2;
    const newPrice = currentPrice + priceChange;
    
    // Update the current price field
    els.currentPrice.value = newPrice.toFixed(2);
    
    // Add visual feedback for price movement
    els.currentPrice.classList.remove('price-up', 'price-down');
    setTimeout(() => {
      els.currentPrice.classList.add(priceChange >= 0 ? 'price-up' : 'price-down');
    }, 10);
    
    // Update calculations with new price
    computeAndRender();
  }

  function startLivePriceSimulation() {
    // Update indices every 3 seconds
    setInterval(updateIndexPrices, 3000);
    
    // Update stock price every 2 seconds
    setInterval(updateStockPrice, 2000);
    
    // Initial update
    updateIndexPrices();
  }

  // --- CORE LOGIC ---
  function calculatePositionSize() {
    const entry = parseFloat(els.entryPrice.value);
    const sl = parseFloat(els.stoplossPrice.value);
    const risk = parseFloat(els.risk.value);

    // Input validation
    let isValid = true;
    els.entryPrice.classList.remove('border-red-500');
    els.stoplossPrice.classList.remove('border-red-500');

    if (isNaN(entry) || isNaN(sl) || isNaN(risk) || entry <= 0 || sl <= 0 || risk <= 0) {
      isValid = false;
    } else {
      if ((state.isLong && sl >= entry) || (!state.isLong && sl <= entry)) {
        els.stoplossPrice.classList.add('border-red-500');
        isValid = false;
      }
    }

    if (isValid) {
      const riskPerShare = Math.abs(entry - sl);
      const positionSize = Math.floor(risk / riskPerShare);
      els.riskPerShare.textContent = cur(riskPerShare);
      els.positionSize.textContent = `${fmt(positionSize)} shares`;
      state.totalShares = positionSize;
    } else {
      els.riskPerShare.textContent = '—';
      els.positionSize.textContent = '—';
      state.totalShares = 0;
    }
    
    // Persist sizing inputs
    state.entryPrice = els.entryPrice.value;
    state.stoplossPrice = els.stoplossPrice.value;
    
    computeAndRender();
    triggerAutoSave();
  }
  
  function distributeQuantities() {
      if (state.totalShares <= 0) {
          Modal.show({ title: 'Error', message: 'Please calculate a valid position size first by entering Initial Entry, Stoploss, and Risk.', confirmText: 'OK' });
          return;
      }
      
      const levelType = els.levelType.value;
      const ratios = DISTRIBUTION_RATIOS[levelType] || DISTRIBUTION_RATIOS['5'];
      
      const totalRatio = ratios.reduce((sum, r) => sum + r, 0);
      const unitSize = state.totalShares / totalRatio;
      
      state.entries = ratios.map((ratio, index) => ({
          level: index + 1,
          quantity: Math.round(ratio * unitSize),
          price: 0,
          status: 'pending',
          executed: false
      }));
      
      // Adjust last entry to match total shares exactly
      const distributedSum = state.entries.reduce((sum, e) => sum + e.quantity, 0);
      const difference = state.totalShares - distributedSum;
      if (state.entries.length > 0) {
          state.entries[state.entries.length - 1].quantity += difference;
      }
      
      // Calculate entry prices
      const riskPerShare = Math.abs(parseFloat(els.entryPrice.value) - parseFloat(els.stoplossPrice.value));
      state.entries.forEach((entry, index) => {
        if (index === 0) {
          entry.price = parseFloat(els.entryPrice.value);
        } else {
          const priceIncrement = state.isLong ? riskPerShare : -riskPerShare;
          entry.price = state.entries[index - 1].price + priceIncrement;
        }
      });
      
      renderEntries();
      computeAndRender();
      triggerAutoSave();
  }

  // --- RENDERING ---
  function renderUI() {
    renderTabs();
    
    // Update form fields from state
    els.scriptName.value = state.scriptName;
    els.currentPrice.value = state.currentPrice;
    els.risk.value = state.risk;
    els.levelType.value = state.levelType;
    els.entryPrice.value = state.entryPrice;
    els.stoplossPrice.value = state.stoplossPrice;
    
    updateTradeTypeButton();
    updateDirectionButton();
    renderEntries();
    calculatePositionSize(); // This also calls computeAndRender
  }
  
  function updateTradeTypeButton() {
      if (state.isIntraday) {
          els.tradeType.textContent = 'INTRADAY';
          els.tradeType.className = 'px-3 py-2 text-sm font-bold rounded-lg transition-all duration-200 bg-blue-600 text-white focus-ring';
      } else {
          els.tradeType.textContent = 'POSITIONAL';
          els.tradeType.className = 'px-3 py-2 text-sm font-bold rounded-lg transition-all duration-200 bg-purple-600 text-white focus-ring';
      }
  }
  
  function updateDirectionButton() {
      if (state.isLong) {
          els.tradeDirection.textContent = 'Long ▲';
          els.tradeDirection.className = 'px-4 py-2 text-sm font-bold rounded-lg transition-all duration-200 w-28 bg-green-600 hover:bg-green-700 text-white focus-ring';
      } else {
          els.tradeDirection.textContent = 'Short ▼';
          els.tradeDirection.className = 'px-4 py-2 text-sm font-bold rounded-lg transition-all duration-200 w-28 bg-red-600 hover:bg-red-700 text-white focus-ring';
      }
  }

  function renderEntries() {
    els.entriesContainer.innerHTML = '';
    if (state.entries.length === 0) {
        els.entriesContainer.innerHTML = `<div class="text-center text-sm text-gray-500 py-4">No entries distributed.</div>`;
        return;
    }
    
    state.entries.forEach((entry, index) => {
      const entryValue = entry.price && entry.quantity ? entry.quantity * entry.price : 0;
      const statusClass = entry.executed ? 
        (entry.status === 'executed' ? 'bg-green-700 text-green-100' : 'bg-blue-700 text-blue-100') : 
        'bg-gray-700 text-gray-300';
      
      const entryDiv = document.createElement('div');
      entryDiv.className = 'bg-gray-900 border border-gray-700 rounded-lg p-3';
      entryDiv.innerHTML = `
        <div class="flex justify-between items-center mb-2">
          <div class="text-xs font-bold text-gray-400">LEVEL #${entry.level}</div>
          <div class="text-xs font-semibold ${statusClass} px-2 py-0.5 rounded-full">${entry.executed ? (entry.status === 'executed' ? 'EXECUTED' : 'NOTIFIED') : 'PENDING'}</div>
        </div>
        <div class="grid grid-cols-2 gap-3 items-center mb-2">
          <div>
            <label class="text-xs text-gray-500 block">Price</label>
            <input type="number" class="entry-price w-full bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-sm focus-ring"
                   value="${entry.price || ''}" data-index="${index}" placeholder="0.00" step="0.05" ${entry.executed ? 'disabled' : ''}>
          </div>
          <div>
            <div class="text-xs text-gray-500">Value</div>
            <div class="entry-value font-semibold text-sm">${entryValue ? cur(entryValue) : '—'}</div>
          </div>
        </div>
        <div class="flex justify-between items-center">
          <div class="text-xs font-semibold bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full">${fmt(entry.quantity)} shares</div>
        </div>
      `;
      els.entriesContainer.appendChild(entryDiv);
    });
  }

  function computeAndRender() {
    const risk = parseFloat(els.risk.value) || 0;
    const cpx = els.currentPrice.value === '' ? NaN : parseFloat(els.currentPrice.value);

    let tableRows = '';
    let cumQty = 0;
    let totalCost = 0;
    let combinedSL = NaN;
    let validEntriesCount = 0;
    let finalAvg = NaN;
    
    // Filter only executed entries
    const executedEntries = state.entries.filter(e => e.executed);

    executedEntries.forEach((entry, idx) => {
      const { quantity, price, status } = entry;
      validEntriesCount++;
      const entryValue = quantity * price;
      cumQty += quantity;
      totalCost += entryValue;
      const avgCost = totalCost / cumQty;
      finalAvg = avgCost;
      const sl = state.isLong ? avgCost - (risk / cumQty) : avgCost + (risk / cumQty);
      combinedSL = sl;
      
      const pnlAtNow = isFinite(cpx) ? (state.isLong ? (cpx - avgCost) * cumQty : (avgCost - cpx) * cumQty) : NaN;
      
      const statusClass = status === 'executed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
      const pnlNowClass = pnlAtNow >= 0 ? 'text-green-400' : 'text-red-400';
      
      tableRows += `
        <tr class="hover:bg-gray-700/50">
          <td class="p-3 font-semibold">#${entry.level}</td>
          <td class="p-3 text-right">${fmt(quantity)}</td>
          <td class="p-3 text-right">${cur(price)}</td>
          <td class="p-3 text-right">${cur(entryValue)}</td>
          <td class="p-3 text-right"><span class="text-xs px-2 py-1 rounded-full ${statusClass}">${status.toUpperCase()}</span></td>
          <td class="p-3 text-right font-bold ${pnlNowClass}">${isFinite(cpx) ? cur(pnlAtNow) : '—'}</td>
        </tr>
      `;
    });

    els.tbody.innerHTML = tableRows || `<tr><td colspan="6" class="p-4 text-center text-gray-500">No executed entries yet.</td></tr>`;

    // Update Summary
    if (validEntriesCount > 0) {
      const finalPnl = isFinite(cpx) ? (state.isLong ? (cpx - finalAvg) * cumQty : (finalAvg - cpx) * cumQty) : NaN;
      const pnlClass = finalPnl >= 0 ? 'text-green-400' : 'text-red-400';
      
      els.summaryPosition.textContent = `${fmt(cumQty)} shares`;
      els.summaryAvgPrice.textContent = cur(finalAvg);
      els.summaryTotalValue.textContent = cur(totalCost);
      els.combinedSL.textContent = cur(combinedSL);
      els.combinedSL.className = `text-xl font-bold mt-1 ${state.isLong ? 'text-green-400' : 'text-red-400'}`;
      els.summaryPnl.textContent = isFinite(finalPnl) ? cur(finalPnl) : '—';
      els.summaryPnl.className = `text-2xl font-bold mt-1 ${pnlClass}`;
    } else {
      els.summaryPosition.textContent = '—';
      els.summaryAvgPrice.textContent = '—';
      els.summaryTotalValue.textContent = '—';
      els.combinedSL.textContent = '—';
      els.combinedSL.className = 'text-xl font-bold mt-1';
      els.summaryPnl.textContent = '—';
      els.summaryPnl.className = 'text-2xl font-bold mt-1';
    }
    
    renderGraph(finalAvg, combinedSL, cpx, executedEntries);
    triggerAutoSave();
  }
  
  function renderGraph(avgPrice, stoplossPrice, currentPrice, entries) {
      if (chartInstance) {
          chartInstance.destroy();
      }

      const hasData = isFinite(avgPrice) && isFinite(stoplossPrice);
      if (!hasData) return;
      
      const entryPoints = entries.map((entry, index) => ({
          x: index + 1,
          y: entry.price
      }));

      const annotations = {
          stoploss: {
              type: 'line',
              yMin: stoplossPrice,
              yMax: stoplossPrice,
              borderColor: '#ef4444',
              borderWidth: 2,
              borderDash: [6, 6],
              label: {
                  content: `SL: ${cur(stoplossPrice)}`,
                  enabled: true,
                  position: 'start',
                  backgroundColor: 'rgba(239, 68, 68, 0.8)',
                  font: { weight: 'bold' }
              }
          },
          avgPrice: {
              type: 'line',
              yMin: avgPrice,
              yMax: avgPrice,
              borderColor: '#3b82f6',
              borderWidth: 2,
              label: {
                  content: `Avg: ${cur(avgPrice)}`,
                  enabled: true,
                  position: 'start',
                  backgroundColor: 'rgba(59, 130, 246, 0.8)',
                  font: { weight: 'bold' }
              }
          }
      };
      
      if(isFinite(currentPrice)) {
          annotations.currentPrice = {
              type: 'line',
              yMin: currentPrice,
              yMax: currentPrice,
              borderColor: 'rgba(229, 231, 235, 0.8)',
              borderWidth: 2,
              borderDash: [2, 2],
              label: {
                  content: `Current: ${cur(currentPrice)}`,
                  enabled: true,
                  position: 'end',
                  backgroundColor: 'rgba(107, 114, 128, 0.8)',
                  font: { weight: 'bold' }
              }
          }
      }

      const ctx = els.priceChart.getContext('2d');
      chartInstance = new Chart(ctx, {
          type: 'scatter',
          data: {
              datasets: [{
                  label: 'Entries',
                  data: entryPoints,
                  backgroundColor: '#22c55e', // green-500
                  pointRadius: 6,
                  pointHoverRadius: 8
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  x: {
                      grid: { color: 'rgba(255, 255, 255, 0.1)' },
                      ticks: { 
                        color: '#9ca3af',
                        callback: function(value, index, values) {
                            return 'Entry ' + value;
                        }
                      },
                      min: 0,
                      max: entries.length + 1
                  },
                  y: {
                      position: 'right',
                      grid: { color: 'rgba(255, 255, 255, 0.1)' },
                      ticks: { color: '#d1d5db' },
                  }
              },
              plugins: {
                  legend: { display: false },
                  tooltip: {
                      callbacks: {
                          label: function(context) {
                              return `Entry #${context.parsed.x}: ${cur(context.parsed.y)}`;
                          }
                      }
                  },
                  annotation: {
                      annotations: annotations
                  }
              }
          }
      });
  }
  
  // --- EVENT HANDLERS ---
  function handleEntryInputChange(e) {
      if (e.target.classList.contains('entry-price')) {
          const index = parseInt(e.target.dataset.index);
          const price = parseFloat(e.target.value) || 0;
          if (state.entries[index]) {
              state.entries[index].price = price;
              // Update value display without full re-render for responsiveness
              const valueEl = e.target.closest('.grid').querySelector('.entry-value');
              if(valueEl) {
                  const entryValue = state.entries[index].quantity * price;
                  valueEl.textContent = cur(entryValue);
              }
              computeAndRender();
              triggerAutoSave();
          }
      }
  }

  function toggleTradeDirection() {
    state.isLong = !state.isLong;
    updateDirectionButton();
    calculatePositionSize(); // Re-validate and re-calculate
    triggerAutoSave();
  }
  
  function toggleTradeType() {
    state.isIntraday = !state.isIntraday;
    updateTradeTypeButton();
    triggerAutoSave();
  }
  
  async function handleReset() {
      const confirmed = await Modal.show({
          title: 'Reset Tab Data',
          message: `Are you sure you want to reset all data for the "${state.scriptName}" tab? This action cannot be undone.`,
          confirmText: 'Yes, Reset',
      });
      if (confirmed) {
          state.entries = [];
          state.entryPrice = '';
          state.stoplossPrice = '';
          state.currentPrice = '';
          renderUI();
          triggerAutoSave();
      }
  }
  
  function handleAddSample() {
      // Set sample data based on selected script
      const script = els.scriptName.value;
      const basePrice = STOCK_PRICES[script] || 100;
      
      els.entryPrice.value = basePrice;
      els.stoplossPrice.value = state.isLong ? basePrice * 0.97 : basePrice * 1.03;
      calculatePositionSize();
      setTimeout(() => {
          distributeQuantities();
          setTimeout(() => {
              renderEntries();
              computeAndRender();
              triggerAutoSave();
          }, 50);
      }, 50);
  }
  
  async function handleRenameTab() {
      const newName = await Modal.show({
          title: 'Rename Tab',
          message: 'Enter a new name for this script tab:',
          confirmText: 'Rename',
          showInput: true,
          inputValue: state.scriptName
      });
      if (newName && newName.trim() !== '') {
          state.scriptName = newName.trim();
          renderTabs();
          saveCurrentTabState();
      }
  }
  
  async function handleDeleteTab() {
      if (Object.keys(tabs).length <= 1) {
          Modal.show({ title: 'Cannot Delete', message: 'You cannot delete the last remaining tab.', confirmText: 'OK'});
          return;
      }
      const confirmed = await Modal.show({
          title: 'Delete Tab',
          message: `Are you sure you want to permanently delete the "${state.scriptName}" tab?`,
          confirmText: 'Delete',
      });
      if (confirmed) {
          delete tabs[currentTabId];
          const remainingTabIds = Object.keys(tabs);
          const newCurrentTabId = remainingTabIds[0];
          saveTabs();
          switchTab(newCurrentTabId);
      }
  }

  // --- TAB MANAGEMENT ---
  function addNewTab() {
    const newTabId = `tab_${Date.now()}`;
    tabs[newTabId] = { ...DEFAULT_STATE, scriptName: `SCRIPT ${Object.keys(tabs).length + 1}` };
    saveTabs();
    switchTab(newTabId);
  }

  function switchTab(tabId) {
    if (!tabs[tabId]) return;
    
    // Save current state before switching
    saveCurrentTabState();
    
    currentTabId = tabId;
    state = { ...tabs[tabId] };
    safeSet(`${STORAGE_KEY_PREFIX}_activeTab`, currentTabId);
    renderUI();
  }
  
  function saveCurrentTabState() {
      if (!currentTabId || !tabs[currentTabId]) return;
      
      // Update state object from form fields before saving
      state.scriptName = els.scriptName.value;
      state.currentPrice = els.currentPrice.value;
      state.risk = parseFloat(els.risk.value) || 1000;
      state.levelType = els.levelType.value;
      state.entryPrice = els.entryPrice.value;
      state.stoplossPrice = els.stoplossPrice.value;
      
      tabs[currentTabId] = { ...state };
      saveTabs();
  }
  
  function saveTabs() {
      safeSet(`${STORAGE_KEY_PREFIX}_tabs`, tabs);
  }
  
  function renderTabs() {
    els.tabsContainer.innerHTML = '';
    Object.keys(tabs).forEach(tabId => {
      const tabData = tabs[tabId];
      const isActive = tabId === currentTabId;
      const tabEl = document.createElement('div');
      tabEl.className = `relative flex-shrink-0 cursor-pointer px-3 py-2 text-sm font-semibold rounded-lg transition-colors duration-200 ${isActive ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`;
      tabEl.dataset.tabId = tabId;

      const tabText = document.createElement('span');
      tabText.textContent = tabData.scriptName || 'New Tab';
      tabEl.appendChild(tabText);

      // Add rename and delete buttons for active tab
      if (isActive) {
          const btnGroup = document.createElement('div');
          btnGroup.className = 'absolute -top-2 -right-2 flex items-center space-x-1';
          
          const renameBtn = document.createElement('button');
          renameBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`;
          renameBtn.className = 'p-1 bg-gray-600 hover:bg-gray-500 rounded-full transition-colors';
          renameBtn.onclick = (e) => { e.stopPropagation(); handleRenameTab(); };
          
          const deleteBtn = document.createElement('button');
          deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-white"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`;
          deleteBtn.className = 'p-1 bg-red-600 hover:bg-red-500 rounded-full transition-colors';
          deleteBtn.onclick = (e) => { e.stopPropagation(); handleDeleteTab(); };
          
          btnGroup.appendChild(renameBtn);
          btnGroup.appendChild(deleteBtn);
          tabEl.appendChild(btnGroup);
      }
      
      tabEl.addEventListener('click', () => switchTab(tabId));
      els.tabsContainer.appendChild(tabEl);
    });

    // Add "New Tab" button
    const addBtn = document.createElement('button');
    addBtn.textContent = '+';
    addBtn.className = 'flex-shrink-0 w-8 h-8 bg-gray-600 hover:bg-gray-500 text-gray-200 font-bold rounded-full transition-colors duration-200 focus-ring';
    addBtn.addEventListener('click', addNewTab);
    els.tabsContainer.appendChild(addBtn);
  }

  // --- INITIALIZATION ---
  function init() {
    // Load data from localStorage
    const savedTabs = safeGet(`${STORAGE_KEY_PREFIX}_tabs`);
    if (savedTabs && Object.keys(savedTabs).length > 0) {
      tabs = savedTabs;
    } else {
      tabs = { [currentTabId]: { ...DEFAULT_STATE } };
    }
    
    const lastActiveTabId = safeGet(`${STORAGE_KEY_PREFIX}_activeTab`);
    const firstTabId = Object.keys(tabs)[0];
    currentTabId = (lastActiveTabId && tabs[lastActiveTabId]) ? lastActiveTabId : firstTabId;
    
    // Load the current tab's state
    if (tabs[currentTabId]) {
      state = { ...tabs[currentTabId] };
    } else {
      // If the saved tab doesn't exist, create it
      tabs[currentTabId] = { ...DEFAULT_STATE };
      state = { ...DEFAULT_STATE };
    }

    // Attach event listeners
    const debouncedCompute = debounce(computeAndRender, 250);
    const debouncedSizing = debounce(calculatePositionSize, 250);

    els.tradeDirection.addEventListener('click', toggleTradeDirection);
    els.tradeType.addEventListener('click', toggleTradeType);
    els.distributeBtn.addEventListener('click', distributeQuantities);
    els.reset.addEventListener('click', handleReset);
    els.addSample.addEventListener('click', handleAddSample);
    els.entriesContainer.addEventListener('input', handleEntryInputChange);
    els.levelType.addEventListener('change', () => {
      state.entries = []; // Clear entries when level type changes
      renderEntries();
      computeAndRender();
      triggerAutoSave();
    });
    
    // Update current price when script changes
    els.scriptName.addEventListener('change', () => {
      const script = els.scriptName.value;
      const basePrice = STOCK_PRICES[script] || 100;
      els.currentPrice.value = basePrice;
      state.scriptName = script;
      state.currentPrice = basePrice;
      renderTabs();
      triggerAutoSave();
    });

    // Add auto-save to all input changes
    ['risk', 'currentPrice', 'entryPrice', 'stoplossPrice'].forEach(id => {
        els[id].addEventListener('input', () => {
            debouncedCompute();
            triggerAutoSave();
        });
    });
    
    // Add specific handlers for entry/stoploss
    ['entryPrice', 'stoplossPrice'].forEach(id => {
        els[id].addEventListener('input', debouncedSizing);
    });
    
    els.scriptName.addEventListener('change', () => {
        renderTabs();
        triggerAutoSave();
    });

    // Initial render
    renderUI();

    // Show the main content
    setTimeout(() => {
        els.loading.style.opacity = '0';
        els.mainContent.style.opacity = '1';
        setTimeout(() => els.loading.style.display = 'none', 300);
    }, 200);
    
    // Start live price simulation
    startLivePriceSimulation();
    
    // Save before page unload
    window.addEventListener('beforeunload', () => {
      saveCurrentTabState();
    });
  }

  init();
});

// --- PWA SERVICE WORKER (Optional, for offline capability) ---
if ("serviceWorker" in navigator) {
  window.addEventListener('load', () => {
    // A simple service worker can be registered here to cache assets
    // For this self-contained file, a service worker is less critical
    // but can be added for a full offline PWA experience.
    // navigator.serviceWorker.register('/sw.js').catch(console.error);
  });
}
</script>
</body>
</html>
